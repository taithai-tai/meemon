<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meemon | Verify OTP</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4">

<div class="bg-white/10 p-8 rounded-xl w-full max-w-sm">
  <h1 class="text-xl font-bold mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP</h1>

  <p class="text-sm text-white/80 mb-4">
    ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏ó‡∏µ‡πà: <span id="emailShow" class="font-bold text-yellow-300"></span>
  </p>

  <input id="otp"
         inputmode="numeric"
         maxlength="6"
         class="w-full p-2 mb-3 rounded text-black text-center text-xl tracking-widest font-bold"
         placeholder="XXXXXX" />

  <button id="btnVerify" onclick="verifyOtp()"
          class="w-full bg-blue-400 text-black p-2 rounded font-bold">
    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  </button>

  <button id="btnResend" onclick="resendOtp()"
          class="w-full mt-2 bg-white/10 p-2 rounded font-bold">
    ‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡∏°‡πà
  </button>

  <button onclick="backToRegister()"
          class="w-full mt-2 bg-white/10 p-2 rounded font-bold">
    ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  </button>

  <p id="msg" class="text-sm mt-3 text-red-300 min-h-[20px]"></p>
</div>

<script src="config.js">
  const API_URL = window.MEEMON_API_URL;

  // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö register.html
  let email = sessionStorage.getItem("MEEMON_EMAIL") || "";
  const inOtpFlow = sessionStorage.getItem("MEEMON_OTP_FLOW") === "1";

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡∏ä‡∏µ‡πâ /app)
  if (!email) location.replace("/app/register.html");

  document.getElementById("emailShow").innerText = email;

  function setMsg(t, ok=false){
    const el = document.getElementById("msg");
    el.className = "text-sm mt-3 min-h-[20px] " + (ok ? "text-green-400" : "text-red-300");
    el.innerText = t || "";
  }

  async function postForm(obj){
    const form = new URLSearchParams();
    Object.keys(obj).forEach(k => form.append(k, obj[k]));

    const r = await fetch(API_URL, { method: "POST", body: form });
    const text = await r.text();

    try { return JSON.parse(text); }
    catch {
      console.error("NOT JSON:", text);
      return { error: "Server ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON", raw: text.slice(0, 250) };
    }
  }

  async function verifyOtp(){
    // ‚úÖ ‡∏Å‡∏±‡∏ô space/‡πÅ‡∏õ‡∏•‡∏Å‡πÜ
    const otp = (document.getElementById("otp").value || "").trim().replace(/\s+/g, "");
    const btn = document.getElementById("btnVerify");

    if (!otp || otp.length < 6) return setMsg("‡∏Å‡∏£‡∏≠‡∏Å OTP ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 6 ‡∏´‡∏•‡∏±‡∏Å");

    btn.disabled = true;
    setMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP‚Ä¶", true);

    try{
      const data = await postForm({ action: "verifyOtp", email, otp });

      if (!data.success){
        setMsg(data.error || "OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏");
        return;
      }

      // ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏á OTP flow (‡∏Å‡∏±‡∏ô‡∏ß‡∏ô)
      sessionStorage.removeItem("MEEMON_OTP_FLOW");

      setMsg("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶", true);

      // ‚úÖ ‡πÑ‡∏õ login ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å path (/app)
      setTimeout(() => location.replace("/app/login.html"), 500);

    }catch(err){
      console.error(err);
      setMsg("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    }finally{
      btn.disabled = false;
    }
  }

  async function resendOtp(){
    const btn = document.getElementById("btnResend");
    btn.disabled = true;
    setMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡∏°‡πà‚Ä¶", true);

    try{
      const data = await postForm({ action: "sendOtp", email });
      if (data.success){
        setMsg("‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•", true);
      } else {
        setMsg(data.error || "‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    }catch(err){
      console.error(err);
      setMsg("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    }finally{
      btn.disabled = false;
    }
  }

  function backToRegister(){
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
    sessionStorage.removeItem("MEEMON_EMAIL");
    sessionStorage.removeItem("MEEMON_OTP_FLOW");

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö register ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å path (/app)
    location.replace("/app/register.html");
  }

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà flow OTP ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏ó‡∏±‡∏ö)
  window.addEventListener("load", () => {
    if (inOtpFlow && email) {
      // ‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏π‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    }
  });
</script>

</body>
</html>
