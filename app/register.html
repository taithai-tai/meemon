<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Meemon | Register + OTP</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4">

<div class="bg-white/10 p-8 rounded-xl w-full max-w-sm">
  <h1 class="text-xl font-bold mb-4">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h1>

  <!-- STEP 1: REGISTER -->
  <div id="step-register">
    <input id="email" class="w-full p-2 mb-3 rounded text-black" placeholder="Email">
    <input id="password" type="password" class="w-full p-2 mb-3 rounded text-black" placeholder="Password">

    <button onclick="register()" class="w-full bg-green-400 text-black p-2 rounded font-bold">
      ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å & ‡∏™‡πà‡∏á OTP
    </button>

    <p id="msg" class="text-sm mt-3 text-red-300"></p>
  </div>

  <!-- STEP 2: OTP -->
  <div id="step-otp" class="hidden">
    <p class="text-sm text-white/80 mb-2">
      ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏ó‡∏µ‡πà: <span id="otpEmail" class="font-bold text-yellow-300"></span>
    </p>

    <input id="otp" inputmode="numeric" maxlength="6"
           class="w-full p-2 mb-3 rounded text-black text-center tracking-widest font-bold"
           placeholder="‡∏Å‡∏£‡∏≠‡∏Å OTP 6 ‡∏´‡∏•‡∏±‡∏Å">

    <button onclick="verifyOtp()" class="w-full bg-yellow-300 text-black p-2 rounded font-bold">
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP
    </button>

    <button onclick="resendOtp()" class="w-full mt-2 bg-white/10 p-2 rounded font-bold">
      ‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡∏°‡πà
    </button>

    <button onclick="backToRegister()" class="w-full mt-2 bg-white/10 p-2 rounded font-bold">
      ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    </button>

    <p id="otpMsg" class="text-sm mt-3 text-red-300"></p>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzTZTZuyETww0USbembVTkpDKrvREDyDj859bwKv858pZaPP1VK_WTCTb0f9zPTyHXC/exec";

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á
const AFTER_VERIFY_REDIRECT = "login.html"; // ‡πÄ‡∏ä‡πà‡∏ô "login.html" ‡∏´‡∏£‡∏∑‡∏≠ "home.html" (‡∏ß‡πà‡∏≤‡∏á = ‡πÑ‡∏°‡πà redirect)

let currentEmail = sessionStorage.getItem("MEEMON_EMAIL") || "";

function setMsg(id, text, ok=false){
  const el = document.getElementById(id);
  el.className = "text-sm mt-3 " + (ok ? "text-green-400" : "text-red-300");
  el.innerText = text || "";
}

// ‚úÖ ‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô‡∏™‡∏∏‡∏î: ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ server ‡∏™‡πà‡∏á HTML ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡πá‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á
async function postForm(obj){
  const form = new URLSearchParams();
  Object.keys(obj).forEach(k => form.append(k, obj[k]));

  const r = await fetch(API_URL, {
    method:"POST",
    body: form,
    redirect: "follow"
  });

  const text = await r.text();
  try {
    return JSON.parse(text);
  } catch (e) {
    console.error("NOT JSON:", text);
    return {
      error: "Server ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON (‡πÄ‡∏ä‡πá‡∏Å Deploy / Permission ‡∏Ç‡∏≠‡∏á Apps Script)",
      raw: text.slice(0, 250)
    };
  }
}

function showOtpStep(email){
  document.getElementById("step-register").classList.add("hidden");
  document.getElementById("step-otp").classList.remove("hidden");
  document.getElementById("otpEmail").innerText = email;
}

function backToRegister(){
  document.getElementById("step-otp").classList.add("hidden");
  document.getElementById("step-register").classList.remove("hidden");
  setMsg("otpMsg","");
}

async function register() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  setMsg("msg","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‚Ä¶", true);

  if (!email || !password) return setMsg("msg","‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  try {
    const data = await postForm({ action:"register", email, password });

    if (data.success) {
      currentEmail = email;
      sessionStorage.setItem("MEEMON_EMAIL", email);

      showOtpStep(email);
      setMsg("otpMsg","‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ OTP ‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•", true);
    } else {
      setMsg("msg", data.error || "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  } catch (err) {
    console.error(err);
    setMsg("msg","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
  }
}

async function verifyOtp(){
  const otp = document.getElementById("otp").value.trim();
  if (!currentEmail) currentEmail = sessionStorage.getItem("MEEMON_EMAIL") || "";

  setMsg("otpMsg","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP‚Ä¶", true);

  if (!currentEmail) return setMsg("otpMsg","‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà");
  if (!otp || otp.length < 6) return setMsg("otpMsg","‡∏Å‡∏£‡∏≠‡∏Å OTP ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 6 ‡∏´‡∏•‡∏±‡∏Å");

  try{
    const data = await postForm({ action:"verifyOtp", email: currentEmail, otp });

    if (data.success){
      setMsg("otpMsg","‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß", true);

      // ‚úÖ Redirect (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ)
      if (AFTER_VERIFY_REDIRECT) {
        setTimeout(() => location.href = AFTER_VERIFY_REDIRECT, 600);
      }
    } else {
      setMsg("otpMsg", data.error || "OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
  }catch(err){
    console.error(err);
    setMsg("otpMsg","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
  }
}

async function resendOtp(){
  if (!currentEmail) currentEmail = sessionStorage.getItem("MEEMON_EMAIL") || "";
  if (!currentEmail) return setMsg("otpMsg","‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà");

  setMsg("otpMsg","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡∏°‡πà‚Ä¶", true);

  try{
    const data = await postForm({ action:"sendOtp", email: currentEmail });
    if (data.success){
      setMsg("otpMsg","‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•", true);
    } else {
      setMsg("otpMsg", data.error || "‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  }catch(err){
    console.error(err);
    setMsg("otpMsg","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
  }
}

// ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì refresh ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ OTP ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
window.addEventListener("load", () => {
  if (currentEmail) {
    showOtpStep(currentEmail);
  }
});
</script>

</body>
</html>
