<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meemon | ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏∏‡∏ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-900 text-white flex items-center justify-center p-4">

<div class="bg-white/10 p-6 rounded-2xl w-full max-w-sm space-y-4">

  <h1 class="text-xl font-bold text-center">üí∞ ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏∏‡∏ç</h1>

  <!-- STEP 1: AMOUNT -->
  <div id="step1">
    <label class="text-sm text-white/70">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏° (‡∏ö‡∏≤‡∏ó)</label>
    <input
      id="amount"
      type="number"
      min="1"
      placeholder="‡πÄ‡∏ä‡πà‡∏ô 100"
      class="w-full p-3 rounded-xl text-black text-center text-lg font-bold mt-2"
    />

    <button
      onclick="generateQR()"
      class="w-full bg-yellow-300 text-black p-3 rounded-xl font-bold mt-4">
      ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
    </button>
  </div>

  <!-- STEP 2: QR -->
  <div id="step2" class="hidden text-center space-y-3">
    <img id="qrImg"
         class="mx-auto rounded-xl border bg-white p-2"
         alt="PromptPay QR" />

    <div class="text-sm text-white/80">
      ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: <span id="sumAmount" class="font-bold text-yellow-300"></span><br>
      ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°: <span id="sumCredits" class="font-bold text-green-400"></span>
    </div>

    <button
      onclick="goUpload()"
      class="w-full bg-green-400 text-black p-3 rounded-xl font-bold">
      ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ
    </button>
  </div>

  <!-- STEP 3: UPLOAD -->
  <div id="step3" class="hidden space-y-3">
    <input
      type="file"
      id="slipFile"
      accept="image/*"
      class="w-full bg-white text-black p-2 rounded"
    />

    <button
      onclick="uploadSlip()"
      class="w-full bg-blue-400 text-black p-3 rounded-xl font-bold">
      ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ & ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°
    </button>
  </div>

  <!-- MESSAGE -->
  <p id="msg" class="text-center text-sm min-h-[20px]"></p>

</div>
  
<script src="config.js">
/* ================= CONFIG ================= */

const PROMPTPAY = "0661127624";
const CREDIT_PER_BAHT = 10; // 1 ‡∏ö‡∏≤‡∏ó = 10 ‡πÅ‡∏ï‡πâ‡∏°
const API_URL = window.MEEMON_API_URL; // üî¥ ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

/* ================= STATE ================= */

const amountEl = document.getElementById("amount");
const qrImg = document.getElementById("qrImg");
const sumAmountEl = document.getElementById("sumAmount");
const sumCreditsEl = document.getElementById("sumCredits");
const msgEl = document.getElementById("msg");

let currentAmount = 0;

/* ================= UI ================= */

function msg(t, ok=false){
  msgEl.className = "text-center text-sm " + (ok ? "text-green-400" : "text-red-300");
  msgEl.innerText = t || "";
}

function show(step){
  ["step1","step2","step3"].forEach(id=>{
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById(step).classList.remove("hidden");
}

/* ================= LOGIC ================= */

function generateQR(){
  const amount = Number(amountEl.value || 0);
  if (!amount || amount <= 0) return msg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");

  currentAmount = amount;

  qrImg.src = `https://promptpay.io/${PROMPTPAY}/${amount}.png`;
  sumAmountEl.innerText = `‡∏ø${amount.toLocaleString()}`;
  sumCreditsEl.innerText = (amount * CREDIT_PER_BAHT).toLocaleString();

  show("step2");
  msg("‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ", true);
}

function goUpload(){
  show("step3");
  msg("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", true);
}

async function uploadSlip(){
  const file = document.getElementById("slipFile").files[0];
  if (!file) return msg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ");

  msg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‚Ä¶", true);

  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result.split(",")[1];

    const form = new URLSearchParams();
    form.append("action", "verifySlip");
    form.append("amount", currentAmount);
    form.append("slip", base64);

    try{
      const r = await fetch(API_URL, { method:"POST", body: form });
      const data = await r.json();

      if (!data.success){
        msg(data.error || "‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
      }

      msg("‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏∏‡∏ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ", true);
      show("step1");
      amountEl.value = "";
    }catch(e){
      console.error(e);
      msg("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    }
  };
  reader.readAsDataURL(file);
}
</script>

</body>
</html>
