<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meemon | Topup</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-900 text-white flex items-center justify-center p-4">

<div class="w-full max-w-md bg-white/10 rounded-2xl p-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-xl font-bold">‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏∏‡∏ç‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏•‡∏¥‡∏õ</h1>
    <a href="home.html" class="text-sm underline text-yellow-300">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Home</a>
  </div>

  <div class="text-sm text-white/70 mb-4">
    ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö SlipOK ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ ‚úÖ
  </div>

  <div class="space-y-3">
    <div class="bg-black/30 rounded-xl p-4">
      <div class="text-xs text-white/60 mb-2">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ (JPG/PNG/WEBP)</div>
      <input id="file" type="file" accept="image/*"
             class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-yellow-300 file:text-black file:font-bold" />
      <img id="preview" class="mt-3 hidden w-full rounded-xl border border-white/10" />
    </div>

    <div class="bg-black/30 rounded-xl p-4">
      <div class="text-xs text-white/60 mb-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡∏™‡∏•‡∏¥‡∏õ)</div>
      <input id="amount" inputmode="decimal" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100.00"
             class="w-full p-3 rounded-lg text-black" />
      <div class="text-xs text-white/50 mt-2">
        * ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏¢‡∏≠‡∏î)
      </div>
    </div>

    <button id="btn" onclick="submitSlip()"
            class="w-full bg-green-400 text-black font-bold py-3 rounded-xl">
      ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ & ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°
    </button>

    <p id="msg" class="text-sm min-h-[20px] text-red-300"></p>

    <div id="result" class="hidden mt-4 bg-emerald-500/10 border border-emerald-400/30 rounded-xl p-4">
      <div class="font-bold text-emerald-300 mb-2">‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
      <div class="text-sm text-white/80 space-y-1">
        <div>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: <span id="rAmount" class="font-bold text-yellow-300"></span></div>
        <div>‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: <span id="rPoints" class="font-bold text-yellow-300"></span></div>
        <div>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: <span id="rRef" class="font-mono text-white/90"></span></div>
      </div>
    </div>
  </div>
</div>

<script>
  // üî• ‡πÉ‡∏™‡πà URL Web App ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ login/register
  const API_URL = "https://script.google.com/macros/s/AKfycbzVd-VNUeXbmecyTk1ITZOssdNm7uTb0ZFFHkcPgmjJaa6iJM56QLiwA9iKhG8HW3M/exec";

  // ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ MEEMON_UID ‡πÉ‡∏ô localStorage ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
  const uid = localStorage.getItem("MEEMON_UID");
  if (!uid) location.replace("login.html");

  const fileEl = document.getElementById("file");
  const previewEl = document.getElementById("preview");
  const msgEl = document.getElementById("msg");
  const btnEl = document.getElementById("btn");

  fileEl.addEventListener("change", () => {
    msg("");
    const f = fileEl.files?.[0];
    if (!f) return;

    const url = URL.createObjectURL(f);
    previewEl.src = url;
    previewEl.classList.remove("hidden");
  });

  function msg(t, ok=false){
    msgEl.className = "text-sm min-h-[20px] " + (ok ? "text-green-400" : "text-red-300");
    msgEl.innerText = t || "";
  }

  function toBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        // data:image/png;base64,XXXX -> ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ XXXX
        const s = String(reader.result || "");
        const base64 = s.includes(",") ? s.split(",")[1] : s;
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function postForm(obj){
    const form = new URLSearchParams();
    Object.keys(obj).forEach(k => form.append(k, obj[k]));

    const r = await fetch(API_URL, { method: "POST", body: form });
    const text = await r.text();

    try { return JSON.parse(text); }
    catch {
      console.error("NOT JSON:", text);
      return { success:false, error:"Server ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON", raw:text.slice(0,250) };
    }
  }

  async function submitSlip(){
    const f = fileEl.files?.[0];
    if (!f) return msg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô");

    btnEl.disabled = true;
    btnEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
    msg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö SlipOK‚Ä¶", true);

    try{
      const base64 = await toBase64(f);
      const amount = document.getElementById("amount").value.trim();

      // action ‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ Apps Script ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô topupSlip)
      const payload = {
        action: "topupSlip",
        uid,
        files: base64,
        log: "true"
      };

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ amount ‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á
      if (amount) payload.amount = amount;

      const data = await postForm(payload);

      if (!data.success){
        msg(data.error || "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô");
        return;
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      document.getElementById("result").classList.remove("hidden");
      document.getElementById("rAmount").innerText = (data.amount ?? "-");
      document.getElementById("rPoints").innerText = (data.points ?? "-");
      document.getElementById("rRef").innerText = (data.transRef ?? "-");

      msg("‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ", true);

      // ‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö home ‡∏Å‡πá‡πÑ‡∏î‡πâ
      // setTimeout(() => location.href = "home.html", 900);

    }catch(err){
      console.error(err);
      msg("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    }finally{
      btnEl.disabled = false;
      btnEl.innerText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ & ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ï‡πâ‡∏°";
    }
  }
</script>

</body>
</html>
